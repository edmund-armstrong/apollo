<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Apollo âœˆï¸</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3d;
    --accent: #6c8eff;
    --accent2: #a78bfa;
    --text: #e8eaf6;
    --muted: #6b7280;
    --success: #34d399;
    --danger: #f87171;
    --warn: #fbbf24;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; display: flex; flex-direction: column;
  }
  header {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    background: var(--surface); flex-shrink: 0;
  }
  header h1 { font-size: 1.25rem; font-weight: 700; }
  .tabs {
    display: flex; border-bottom: 1px solid var(--border);
    background: var(--surface); padding: 0 20px; flex-shrink: 0;
  }
  .tab {
    padding: 11px 18px; cursor: pointer; font-size: 0.88rem;
    color: var(--muted); border-bottom: 2px solid transparent;
    transition: all 0.2s; user-select: none;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab:hover:not(.active) { color: var(--text); }
  .panel { display: none; flex: 1; overflow-y: auto; }
  .panel.active { display: flex; flex-direction: column; }

  /* â”€â”€ Trip Shelf â”€â”€ */
  .shelf {
    padding: 14px 20px 10px;
    display: flex; gap: 8px; align-items: center;
    overflow-x: auto; flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  .shelf::-webkit-scrollbar { display: none; }
  .shelf-chip {
    padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
    cursor: pointer; font-size: 0.82rem; white-space: nowrap;
    transition: all 0.15s; background: var(--bg); flex-shrink: 0;
  }
  .shelf-chip:hover { border-color: var(--muted); }
  .shelf-chip.active { border-color: var(--accent); background: #1e2448; color: var(--accent); }
  .shelf-chip.new-chip {
    border-color: var(--accent); color: var(--accent);
    background: transparent; font-weight: 600;
  }
  .shelf-chip.new-chip:hover { background: #1e2448; }

  /* â”€â”€ Notebook â”€â”€ */
  .notebook-wrap {
    flex: 1; display: flex; flex-direction: column;
    padding: 20px; gap: 12px; max-width: 740px; width: 100%; margin: 0 auto;
  }
  .trip-header {
    display: flex; align-items: center; gap: 10px;
  }
  .trip-name-input {
    background: transparent; border: none; border-bottom: 1px solid transparent;
    color: var(--text); font-size: 1.1rem; font-weight: 600;
    padding: 2px 4px; outline: none; flex: 1;
    transition: border-color 0.2s;
  }
  .trip-name-input:hover, .trip-name-input:focus { border-bottom-color: var(--border); }
  .item-count { font-size: 0.78rem; color: var(--muted); white-space: nowrap; }
  .notebook-area {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
  }
  .notebook-area textarea {
    width: 100%; background: transparent; border: none;
    color: var(--text); font-size: 0.95rem; padding: 16px;
    min-height: 120px; resize: none; outline: none;
    font-family: inherit; line-height: 1.6;
  }
  .notebook-area textarea::placeholder { color: var(--muted); }
  .capture-toolbar {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; border-top: 1px solid var(--border);
    background: var(--bg);
  }
  .tool-btn {
    padding: 7px 13px; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer;
    font-size: 0.82rem; transition: all 0.15s;
  }
  .tool-btn:hover { color: var(--text); border-color: var(--muted); }
  .tool-btn.recording { color: var(--danger); border-color: var(--danger); }
  .add-btn {
    margin-left: auto; padding: 7px 18px; border-radius: 8px;
    background: var(--accent); color: #fff; border: none;
    font-size: 0.88rem; font-weight: 600; cursor: pointer;
    transition: opacity 0.15s;
  }
  .add-btn:hover { opacity: 0.85; }
  .add-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* â”€â”€ Feed â”€â”€ */
  .feed-header {
    font-size: 0.75rem; color: var(--muted); text-transform: uppercase;
    letter-spacing: 0.5px; margin-top: 4px;
  }
  .feed-items { display: flex; flex-direction: column; gap: 8px; }
  .feed-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 14px;
    display: flex; align-items: flex-start; gap: 10px;
  }
  .feed-icon { font-size: 1rem; flex-shrink: 0; margin-top: 1px; }
  .feed-content { flex: 1; min-width: 0; }
  .feed-label { font-size: 0.82rem; color: var(--muted); margin-bottom: 2px; }
  .feed-preview {
    font-size: 0.88rem; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .feed-url { font-size: 0.8rem; color: var(--accent); }

  /* â”€â”€ Empty state â”€â”€ */
  .empty-notebook {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; padding: 40px 20px; gap: 12px;
  }
  .empty-notebook .icon { font-size: 3rem; }
  .empty-notebook h2 { font-size: 1.1rem; font-weight: 600; }
  .empty-notebook p { color: var(--muted); font-size: 0.9rem; max-width: 280px; }

  /* â”€â”€ Shared cards â”€â”€ */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px;
  }
  .card h3 {
    font-size: 0.82rem; color: var(--muted); margin-bottom: 12px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .padded { padding: 20px; max-width: 740px; width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 14px; }
  input, textarea, select {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px; padding: 10px 14px;
    font-size: 0.92rem; font-family: inherit; outline: none;
    transition: border-color 0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 90px; }
  .btn {
    padding: 9px 18px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 0.88rem; font-weight: 600; transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { opacity: 0.85; }
  .btn-secondary { background: var(--border); color: var(--text); }
  .btn-sm { padding: 6px 13px; font-size: 0.8rem; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .flex-1 { flex: 1; }

  /* â”€â”€ Itinerary â”€â”€ */
  #itinerary-output {
    white-space: pre-wrap; line-height: 1.7; font-size: 0.92rem;
    max-height: 520px; overflow-y: auto;
  }
  #itinerary-output strong { color: var(--accent2); }

  /* â”€â”€ Chat â”€â”€ */
  #chat-messages {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column;
    gap: 12px; min-height: 300px; max-height: 480px;
  }
  .msg {
    max-width: 78%; padding: 11px 15px; border-radius: 12px;
    font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap;
  }
  .msg-user { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
  .msg-assistant { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg-assistant strong { color: var(--accent2); }
  .geo-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 0.78rem; color: var(--success); cursor: pointer;
    padding: 4px 10px; border: 1px solid var(--success); border-radius: 20px;
  }
  .geo-badge.off { color: var(--muted); border-color: var(--muted); }

  /* â”€â”€ Gmail â”€â”€ */
  .email-card {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px; display: flex;
    flex-direction: column; gap: 6px;
  }
  .email-card .subject { font-weight: 600; font-size: 0.9rem; }
  .email-card .meta { font-size: 0.76rem; color: var(--muted); }
  .email-card .snippet { font-size: 0.82rem; color: var(--muted); line-height: 1.5; }

  /* â”€â”€ Toast â”€â”€ */
  #toast {
    position: fixed; bottom: 20px; right: 20px;
    background: var(--surface); border: 1px solid var(--border);
    padding: 10px 18px; border-radius: 10px; font-size: 0.86rem;
    opacity: 0; transition: opacity 0.25s; pointer-events: none; z-index: 999;
  }
  #toast.show { opacity: 1; }
  .spinner { display: inline-block; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <span style="font-size:1.4rem">âœˆï¸</span>
  <h1>Apollo</h1>
  <span style="margin-left:auto;font-size:0.78rem;color:var(--muted)">AI Travel Planner</span>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('capture')">ğŸ““ Capture</div>
  <div class="tab" onclick="switchTab('gmail')">ğŸ“§ Gmail</div>
  <div class="tab" onclick="switchTab('itinerary')">ğŸ—ºï¸ Itinerary</div>
  <div class="tab" onclick="switchTab('chat')">ğŸ’¬ Chat</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CAPTURE TAB â€” blank notebook, zero friction
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="tab-capture">

  <!-- Trip shelf -->
  <div class="shelf" id="trip-shelf">
    <div class="shelf-chip new-chip" onclick="quickNewTrip()">+ New Trip</div>
  </div>

  <!-- Empty state (no trip selected) -->
  <div class="empty-notebook" id="empty-state">
    <div class="icon">ğŸ““</div>
    <h2>Start a new trip</h2>
    <p>Tap <strong>+ New Trip</strong> above and start dumping anything you know â€” notes, links, ideas, addresses.</p>
  </div>

  <!-- Notebook (shown when a trip is selected) -->
  <div class="notebook-wrap" id="notebook-wrap" style="display:none">
    <div class="trip-header">
      <input class="trip-name-input" id="trip-name-input"
        placeholder="Trip name"
        onblur="saveTriName()" onkeydown="if(event.key==='Enter')this.blur()" />
      <span class="item-count" id="trip-item-count"></span>
    </div>

    <div class="notebook-area">
      <textarea id="capture-text"
        placeholder="What do you know about this trip? Paste anything â€” notes, addresses, links, ideas, stream of consciousnessâ€¦"
        onpaste="handlePaste(event)"
        onkeydown="if(event.key==='Enter'&&(event.metaKey||event.ctrlKey))addCapture()"></textarea>
      <div class="capture-toolbar">
        <button class="tool-btn" onclick="document.getElementById('file-input').click()">ğŸ“ File / PDF</button>
        <button class="tool-btn" id="voice-btn" onclick="toggleVoice()">ğŸ¤ Voice</button>
        <input type="file" id="file-input" accept="image/*,.pdf,application/pdf" style="display:none" onchange="handleFileCapture(this)" />
        <button class="add-btn" id="add-btn" onclick="addCapture()">Add â†’</button>
      </div>
    </div>

    <div id="feed-section" style="display:none">
      <div class="feed-header" id="feed-header"></div>
      <div class="feed-items" id="feed-items"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GMAIL TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="tab-gmail">
  <div class="padded">
    <div class="card" id="gmail-connect-card">
      <h3>Gmail</h3>
      <div id="gmail-disconnected">
        <p style="color:var(--muted);font-size:0.88rem;margin-bottom:14px">Connect Gmail to scan your inbox for travel emails and add them to any trip.</p>
        <a href="/api/auth/gmail" class="btn btn-primary" style="text-decoration:none;display:inline-block">ğŸ”— Connect Gmail</a>
      </div>
      <div id="gmail-connected" style="display:none">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:var(--success)">âœ“</span>
          <span style="color:var(--success);font-weight:600">Gmail connected</span>
        </div>
      </div>
    </div>

    <div class="card" id="gmail-scan-card" style="display:none">
      <h3>Search Emails</h3>
      <div style="margin-bottom:10px">
        <label style="font-size:0.8rem;color:var(--muted);display:block;margin-bottom:4px">Add to trip</label>
        <select id="gmail-trip-select"><option value="">â€” Select a trip â€”</option></select>
      </div>
      <div style="margin-bottom:10px">
        <label style="font-size:0.8rem;color:var(--muted);display:block;margin-bottom:4px">Keywords (comma-separated)</label>
        <input type="text" id="gmail-keywords" placeholder="e.g. hotel, booking, flight, reservation" />
      </div>
      <button class="btn btn-primary" onclick="scanGmail()" id="scan-btn">ğŸ” Search Inbox</button>
    </div>

    <div class="card" id="gmail-results-card" style="display:none">
      <h3>Matching Emails <span id="email-count" style="color:var(--muted);font-weight:400"></span></h3>
      <div id="email-results" style="display:flex;flex-direction:column;gap:10px"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ITINERARY TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="tab-itinerary">
  <div class="padded">
    <div class="card">
      <h3>Select Trip</h3>
      <div class="row" id="itinerary-trip-list" style="flex-wrap:wrap;gap:8px"></div>
    </div>
    <div class="card" id="itinerary-card" style="display:none">
      <div class="row" style="margin-bottom:14px">
        <h3 id="itinerary-trip-name" style="flex:1;text-transform:none;color:var(--text)">Itinerary</h3>
        <button class="btn btn-primary btn-sm" onclick="organizeTrip()" id="organize-btn">âœ¨ Organize with AI</button>
      </div>
      <div id="itinerary-output" style="color:var(--muted);font-style:italic">
        Click "Organize with AI" to generate your itinerary from saved content.
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHAT TAB
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="tab-chat">
  <div class="padded" style="flex:1">
    <div class="card" style="flex:1;display:flex;flex-direction:column;gap:12px">
      <div class="row">
        <div class="flex-1">
          <label style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;display:block">Trip context</label>
          <select id="chat-trip-select" onchange="chatTripId=this.value||null">
            <option value="">â€” No trip â€”</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;display:block">Location</label>
          <div class="geo-badge off" id="geo-badge" onclick="toggleGeo()">ğŸ“ Off</div>
        </div>
      </div>
      <div id="chat-messages"></div>
      <div class="row" style="gap:8px">
        <input type="text" id="chat-input" class="flex-1" placeholder="Ask anything about your tripâ€¦"
          onkeydown="if(event.key==='Enter')sendMessage()" />
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let trips = [];
let activeTripId = null;
let itineraryTripId = null;
let chatTripId = null;
let geoEnabled = false;
let geoCoords = null;
let chatHistory = [];
let recognition = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Boot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadTrips();
  if (new URLSearchParams(location.search).get('gmail') === 'connected') {
    toast('Gmail connected!');
    history.replaceState({}, '', '/');
    switchTab('gmail');
  }
}

async function loadTrips() {
  const res = await fetch('/api/trips');
  trips = (await res.json()).trips;
  renderShelf();
  renderItineraryTrips();
  renderChatTripSelect();
  renderGmailTripSelect();
  if (activeTripId && !trips.find(t => t.id === activeTripId)) activeTripId = null;
  if (activeTripId) renderFeed();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  const names = ['capture','gmail','itinerary','chat'];
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', names[i] === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  if (name === 'gmail') checkGmailStatus();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Trip shelf
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShelf() {
  const shelf = document.getElementById('trip-shelf');
  shelf.innerHTML = '<div class="shelf-chip new-chip" onclick="quickNewTrip()">+ New Trip</div>';
  trips.forEach(t => {
    const chip = document.createElement('div');
    chip.className = 'shelf-chip' + (t.id === activeTripId ? ' active' : '');
    chip.textContent = `${t.name} (${t.items.length})`;
    chip.onclick = () => selectTrip(t.id);
    shelf.appendChild(chip);
  });
}

async function quickNewTrip() {
  const fd = new FormData(); // no name â€” auto-generated
  const res = await fetch('/api/trips', { method: 'POST', body: fd });
  const trip = await res.json();
  trips.unshift(trip);
  selectTrip(trip.id);
  renderShelf();
  renderItineraryTrips();
  renderChatTripSelect();
  renderGmailTripSelect();
  // Focus the notebook textarea
  setTimeout(() => document.getElementById('capture-text').focus(), 50);
}

function selectTrip(id) {
  activeTripId = id;
  renderShelf();
  const trip = trips.find(t => t.id === id);
  if (!trip) return;
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('notebook-wrap').style.display = 'flex';
  document.getElementById('trip-name-input').value = trip.name;
  renderFeed();
}

async function saveTriName() {
  if (!activeTripId) return;
  const name = document.getElementById('trip-name-input').value.trim();
  if (!name) return;
  const trip = trips.find(t => t.id === activeTripId);
  if (!trip || trip.name === name) return;
  trip.name = name;
  const fd = new FormData();
  fd.append('name', name);
  await fetch(`/api/trips/${activeTripId}/rename`, { method: 'PATCH', body: fd });
  renderShelf();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Capture
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addCapture() {
  if (!activeTripId) return toast('Select or create a trip first');
  const textarea = document.getElementById('capture-text');
  const raw = textarea.value.trim();
  if (!raw) return;

  const btn = document.getElementById('add-btn');
  btn.disabled = true;

  // Auto-detect URL
  const isUrl = /^https?:\/\/\S+$/.test(raw);
  const fd = new FormData();
  fd.append('content_type', isUrl ? 'link' : 'text');
  if (isUrl) fd.append('url', raw);
  else fd.append('text', raw);

  if (isUrl) toast('Fetching pageâ€¦');

  const res = await fetch(`/api/trips/${activeTripId}/upload`, { method: 'POST', body: fd });
  btn.disabled = false;

  if (!res.ok) {
    toast('Could not save â€” try again');
    return;
  }
  textarea.value = '';
  await loadTrips();
  renderFeed();
}

function handlePaste(e) {
  // Detect URL in clipboard and show hint
  const text = e.clipboardData?.getData('text') || '';
  if (/^https?:\/\/\S+$/.test(text.trim())) {
    document.getElementById('capture-text').placeholder = 'ğŸ”— URL detected â€” tap Add to fetch page details';
    setTimeout(() => {
      document.getElementById('capture-text').placeholder =
        'What do you know about this trip? Paste anything â€” notes, addresses, links, ideas, stream of consciousnessâ€¦';
    }, 3000);
  }
}

async function handleFileCapture(input) {
  if (!activeTripId) { toast('Select or create a trip first'); return; }
  const file = input.files[0];
  if (!file) return;
  toast('Uploadingâ€¦');
  const fd = new FormData();
  fd.append('content_type', 'file');
  fd.append('file', file);
  const res = await fetch(`/api/trips/${activeTripId}/upload`, { method: 'POST', body: fd });
  input.value = '';
  if (!res.ok) { toast('Upload failed'); return; }
  await loadTrips();
  renderFeed();
  toast('File saved!');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Voice
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { toast('Voice not supported â€” use Chrome or Safari'); return; }
  const btn = document.getElementById('voice-btn');

  if (recognition) {
    recognition.stop();
    return;
  }

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  btn.textContent = 'â¹ Stop';
  btn.classList.add('recording');

  recognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    document.getElementById('capture-text').value = transcript;
  };

  recognition.onend = () => {
    recognition = null;
    btn.textContent = 'ğŸ¤ Voice';
    btn.classList.remove('recording');
  };

  recognition.onerror = () => {
    recognition = null;
    btn.textContent = 'ğŸ¤ Voice';
    btn.classList.remove('recording');
    toast('Voice error â€” try again');
  };

  recognition.start();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Feed
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeed() {
  const trip = trips.find(t => t.id === activeTripId);
  if (!trip) return;

  document.getElementById('trip-item-count').textContent =
    trip.items.length ? `${trip.items.length} item${trip.items.length !== 1 ? 's' : ''}` : '';

  const feedSection = document.getElementById('feed-section');
  const feedItems = document.getElementById('feed-items');
  const feedHeader = document.getElementById('feed-header');

  if (!trip.items.length) { feedSection.style.display = 'none'; return; }

  feedSection.style.display = 'block';
  feedHeader.textContent = `Saved (${trip.items.length})`;

  feedItems.innerHTML = [...trip.items].reverse().map(item => {
    const icons = { text: 'ğŸ“', email: 'ğŸ“§', link: 'ğŸ”—', file: 'ğŸ“' };
    const icon = icons[item.type] || 'ğŸ“„';
    const isPdf = item.file_kind === 'document';
    const isImage = item.file_kind === 'image' || item.type === 'image';
    let label = item.label || item.type;
    let preview = '';

    if (item.url) {
      preview = `<div class="feed-url">${escHtml(item.url)}</div>`;
    } else if (isPdf) {
      label = item.filename || 'PDF';
      preview = `<div class="feed-preview" style="color:var(--warn)">ğŸ“„ ${escHtml(item.filename || 'Document')}</div>`;
    } else if (isImage) {
      label = item.filename || 'Image';
      preview = `<div class="feed-preview" style="color:var(--accent2)">ğŸ–¼ï¸ ${escHtml(item.filename || 'Screenshot')}</div>`;
    } else if (item.content) {
      const snippet = item.content.replace(/\n/g,' ').slice(0, 100);
      preview = `<div class="feed-preview">${escHtml(snippet)}${item.content.length > 100 ? 'â€¦' : ''}</div>`;
    }

    return `<div class="feed-item">
      <div class="feed-icon">${icon}</div>
      <div class="feed-content">
        <div class="feed-label">${escHtml(label)}</div>
        ${preview}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Itinerary
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderItineraryTrips() {
  const el = document.getElementById('itinerary-trip-list');
  el.innerHTML = trips.map(t => `
    <div class="shelf-chip ${t.id === itineraryTripId ? 'active' : ''}" onclick="selectItineraryTrip('${t.id}')">
      ${escHtml(t.name)}
    </div>`).join('');
}

function selectItineraryTrip(id) {
  itineraryTripId = id;
  renderItineraryTrips();
  const trip = trips.find(t => t.id === id);
  document.getElementById('itinerary-card').style.display = 'block';
  document.getElementById('itinerary-trip-name').textContent = trip.name;
  if (trip.itinerary) renderItinerary(trip.itinerary);
  else document.getElementById('itinerary-output').innerHTML =
    '<span style="color:var(--muted);font-style:italic">Click "Organize with AI" to generate your itinerary.</span>';
}

async function organizeTrip() {
  if (!itineraryTripId) return toast('Select a trip first');
  const btn = document.getElementById('organize-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner">âŸ³</span> Organizingâ€¦';
  document.getElementById('itinerary-output').innerHTML =
    '<span style="color:var(--muted)">Claude is reading your content and building your itineraryâ€¦</span>';
  const res = await fetch(`/api/trips/${itineraryTripId}/organize`, { method: 'POST' });
  btn.disabled = false;
  btn.innerHTML = 'âœ¨ Organize with AI';
  if (!res.ok) { toast((await res.json()).detail || 'Failed'); return; }
  const data = await res.json();
  await loadTrips();
  renderItinerary(data.itinerary);
}

function renderItinerary(text) {
  let html = text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/^### (.+)$/gm,'<h3 style="color:var(--accent);margin:10px 0 4px">$1</h3>')
    .replace(/^## (.+)$/gm,'<h2 style="color:var(--accent);margin:12px 0 6px">$1</h2>')
    .replace(/^# (.+)$/gm,'<h1 style="color:var(--accent);margin:14px 0 6px">$1</h1>');
  document.getElementById('itinerary-output').innerHTML = html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Chat
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChatTripSelect() {
  const sel = document.getElementById('chat-trip-select');
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” No trip â€”</option>' +
    trips.map(t => `<option value="${t.id}" ${t.id===cur?'selected':''}>${escHtml(t.name)}</option>`).join('');
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  appendMsg('user', text);
  const fd = new FormData();
  fd.append('message', text);
  fd.append('history', JSON.stringify(chatHistory));
  if (chatTripId) fd.append('trip_id', chatTripId);
  if (geoEnabled && geoCoords) {
    fd.append('latitude', geoCoords.lat);
    fd.append('longitude', geoCoords.lng);
  }
  const el = appendMsg('assistant', '');
  let full = '';
  const res = await fetch('/api/chat', { method: 'POST', body: fd });
  const reader = res.body.getReader();
  const dec = new TextDecoder();
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    for (const line of dec.decode(value).split('\n')) {
      if (!line.startsWith('data: ')) continue;
      const p = line.slice(6);
      if (p === '[DONE]') break;
      try { const c = JSON.parse(p); full += c.text; el.innerHTML = renderMd(full); scrollChat(); } catch {}
    }
  }
  chatHistory.push({ role: 'user', content: text });
  chatHistory.push({ role: 'assistant', content: full });
  if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
}

function appendMsg(role, text) {
  const el = document.createElement('div');
  el.className = `msg msg-${role}`;
  el.innerHTML = renderMd(text) || '&nbsp;';
  document.getElementById('chat-messages').appendChild(el);
  scrollChat();
  return el;
}

function scrollChat() {
  const c = document.getElementById('chat-messages');
  c.scrollTop = c.scrollHeight;
}

function renderMd(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Geo
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleGeo() {
  if (!geoEnabled) {
    navigator.geolocation.getCurrentPosition(pos => {
      geoCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      geoEnabled = true;
      const b = document.getElementById('geo-badge');
      b.className = 'geo-badge';
      b.textContent = `ğŸ“ ${geoCoords.lat.toFixed(3)}, ${geoCoords.lng.toFixed(3)}`;
      toast('Location enabled');
    }, () => toast('Location access denied'));
  } else {
    geoEnabled = false; geoCoords = null;
    const b = document.getElementById('geo-badge');
    b.className = 'geo-badge off'; b.textContent = 'ğŸ“ Off';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Gmail
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkGmailStatus() {
  const data = await (await fetch('/api/auth/gmail/status')).json();
  document.getElementById('gmail-disconnected').style.display = data.connected ? 'none' : 'block';
  document.getElementById('gmail-connected').style.display = data.connected ? 'block' : 'none';
  document.getElementById('gmail-scan-card').style.display = data.connected ? 'block' : 'none';
}

function renderGmailTripSelect() {
  const sel = document.getElementById('gmail-trip-select');
  sel.innerHTML = '<option value="">â€” Select a trip â€”</option>' +
    trips.map(t => `<option value="${t.id}">${escHtml(t.name)}</option>`).join('');
}

async function scanGmail() {
  const tripId = document.getElementById('gmail-trip-select').value;
  const keywords = document.getElementById('gmail-keywords').value.trim();
  if (!tripId) return toast('Select a trip first');
  if (!keywords) return toast('Enter keywords');
  const btn = document.getElementById('scan-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner">âŸ³</span> Searchingâ€¦';
  document.getElementById('gmail-results-card').style.display = 'none';
  const fd = new FormData(); fd.append('trip_id', tripId); fd.append('keywords', keywords);
  const res = await fetch('/api/email/scan', { method: 'POST', body: fd });
  btn.disabled = false; btn.innerHTML = 'ğŸ” Search Inbox';
  if (!res.ok) { toast('Scan failed'); return; }
  const { emails } = await res.json();
  document.getElementById('email-count').textContent = `(${emails.length} found)`;
  document.getElementById('gmail-results-card').style.display = 'block';
  if (!emails.length) {
    document.getElementById('email-results').innerHTML =
      '<p style="color:var(--muted);font-size:0.88rem">No emails matched. Try different keywords.</p>';
    return;
  }
  document.getElementById('email-results').innerHTML = emails.map(e => `
    <div class="email-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div>
          <div class="subject">${escHtml(e.subject)}</div>
          <div class="meta">${escHtml(e.sender)} Â· ${escHtml(e.date)}</div>
        </div>
        <button class="btn btn-sm btn-primary" style="white-space:nowrap;flex-shrink:0"
          onclick="addEmailToTrip('${tripId}',${JSON.stringify(e.subject)},${JSON.stringify(e.sender)},${JSON.stringify(e.date)},${JSON.stringify(e.body)},this)">
          + Add
        </button>
      </div>
      <div class="snippet">${escHtml(e.snippet)}</div>
    </div>`).join('');
}

async function addEmailToTrip(tripId, subject, sender, date, body, btn) {
  btn.disabled = true; btn.textContent = 'â€¦';
  const fd = new FormData();
  fd.append('trip_id', tripId); fd.append('subject', subject);
  fd.append('sender', sender); fd.append('date', date); fd.append('body', body);
  const res = await fetch('/api/email/add', { method: 'POST', body: fd });
  if (res.ok) {
    btn.textContent = 'âœ“ Added'; btn.classList.replace('btn-primary','btn-secondary');
    await loadTrips(); toast('Email added!');
  } else { btn.disabled = false; btn.textContent = '+ Add'; toast('Failed'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(msg, ms=2500) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), ms);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Go
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
